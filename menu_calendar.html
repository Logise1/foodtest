<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MenÃº Mensual - Febrero 2026</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Nunito:wght@400;600;700&display=swap');

        :root {
            --primary: #6366f1;
            --secondary: #ec4899;
            --accent: #8b5cf6;
            --bg-color: #f3f4f6;
            --card-bg: rgba(255, 255, 255, 0.9);
            --text-main: #1f2937;
            --text-muted: #6b7280;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
            color: var(--text-main);
            margin: 0;
            padding: 2rem;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            text-align: center;
            font-size: 3rem;
            margin-bottom: 3rem;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1.5rem;
            margin-bottom: 4rem;
        }

        .day-header {
            text-align: center;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--primary);
            padding: 1rem;
            font-size: 1rem;
            letter-spacing: 1px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .day-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 1.25rem;
            min-height: 160px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
            position: relative;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.5);
            display: flex;
            flex-direction: column;
        }

        .day-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: var(--primary);
        }

        .day-number {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 1.5rem;
            color: #d1d5db;
            position: absolute;
            top: 0.5rem;
            right: 1rem;
            z-index: 0;
        }

        .meal-type {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--accent);
            font-weight: 800;
            margin-top: 1.5rem;
            margin-bottom: 0.25rem;
            letter-spacing: 0.5px;
            z-index: 1;
        }

        .meal-content {
            font-size: 1rem;
            line-height: 1.4;
            color: var(--text-main);
            font-weight: 600;
            margin-bottom: 0.5rem;
            z-index: 1;
        }

        .meal-content span {
            /* Side dishes */
            font-weight: 400;
            color: var(--text-muted);
            font-size: 0.9rem;
            display: block;
        }

        .tag {
            display: inline-block;
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 20px;
            margin-top: auto;
            align-self: flex-start;
            font-weight: 700;
            text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .tag-blue {
            background: #e0f2fe;
            color: #0284c7;
        }

        .tag-green {
            background: #dcfce7;
            color: #16a34a;
        }

        .tag-orange {
            background: #ffedd5;
            color: #ea580c;
        }

        .tag-red {
            background: #fee2e2;
            color: #dc2626;
        }

        .tag-purple {
            background: #f3e8ff;
            color: #9333ea;
        }

        .glovo-card {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border: 2px dashed #f59e0b;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .glovo-card .day-number {
            color: #fcd34d;
        }

        .sunday-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #bae6fd;
        }

        .sunday-card .day-number {
            color: #bae6fd;
        }

        .shopping-section {
            background: white;
            border-radius: 24px;
            padding: 3rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .shopping-section h2 {
            font-family: 'Montserrat', sans-serif;
            color: var(--text-main);
            text-align: center;
            font-size: 2rem;
            margin-bottom: 2rem;
        }

        .shopping-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2.5rem;
        }

        .week-list {
            background: #f8fafc;
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
        }

        .week-list h3 {
            font-family: 'Montserrat', sans-serif;
            color: var(--primary);
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 1rem;
            margin-top: 0;
            font-size: 1.25rem;
        }

        .shopping-items li {
            padding: 0.75rem 0;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95rem;
        }

        .shopping-items li span:last-child {
            font-weight: 700;
            color: var(--secondary);
            background: #fce7f3;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .shopping-items li:last-child {
            border-bottom: none;
        }

        .loading {
            text-align: center;
            font-size: 1.5rem;
            margin-top: 3rem;
            color: var(--text-muted);
        }
    </style>
</head>

<body>

    <div class="container">
        <!-- Navigation Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <button onclick="changeMonth(-1)"
                style="background:none; border:none; font-size: 2rem; cursor:pointer; color:var(--primary)">&#10094;</button>
            <h1 id="month-title" style="margin:0;">Febrero 2026</h1>
            <button onclick="changeMonth(1)"
                style="background:none; border:none; font-size: 2rem; cursor:pointer; color:var(--primary)">&#10095;</button>
        </div>

        <div class="calendar-grid" id="calendar">
            <div class="day-header">Lunes</div>
            <div class="day-header">Martes</div>
            <div class="day-header">MiÃ©rcoles</div>
            <div class="day-header">Jueves</div>
            <div class="day-header">Viernes</div>
            <div class="day-header">SÃ¡bado</div>
            <div class="day-header">Domingo</div>
        </div>

        <div class="shopping-section">
            <h2>ðŸ›’ Lista de la Compra</h2>
            <div class="shopping-grid" id="shopping-lists"></div>
        </div>
    </div>

    <script>
        // State
        let currentYear = 2026;
        let currentMonth = 1; // 0=Jan, 1=Feb
        let globalFoodStats = [];
        const users = ['ariel', 'mia', 'rosa', 'david'];

        // Navigation
        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            updateView();
        }

        function updateView() {
            // Update Title
            const date = new Date(currentYear, currentMonth, 1);
            const monthName = date.toLocaleString('es-ES', { month: 'long' });
            const capMonth = monthName.charAt(0).toUpperCase() + monthName.slice(1);
            document.getElementById('month-title').textContent = `${capMonth} ${currentYear}`;

            // Generate
            const schedule = generateSchedule(globalFoodStats, currentYear, currentMonth);
            renderCalendar(schedule);
            generateShoppingList(schedule);
        }

        async function init() {
            try {
                let allData = [];
                for (const user of users) {
                    const response = await fetch(`userdata/${user}.json`);
                    if (response.ok) {
                        const data = await response.json();
                        allData = [...allData, ...data];
                    }
                }
                globalFoodStats = processFoodData(allData);
                updateView();
            } catch (e) {
                document.body.innerHTML = `<div class="loading">Error: ${e.message}<br>Ejecuta en servidor local.</div>`;
            }
        }

        // Data Processing
        function processFoodData(data) {
            const temp = {};
            data.forEach(item => {
                if (!temp[item.foodId]) {
                    temp[item.foodId] = {
                        name: item.foodName,
                        category: item.category,
                        ratings: [],
                        min_rating: 5
                    };
                }
                temp[item.foodId].ratings.push(item.rating);
                if (item.rating < temp[item.foodId].min_rating) temp[item.foodId].min_rating = item.rating;
            });
            return Object.values(temp).map(item => ({
                name: item.name,
                category: item.category,
                avg_rating: item.ratings.reduce((a, b) => a + b, 0) / item.ratings.length,
                min_rating: item.min_rating
            }));
        }

        // --------------------------------------------------------------------------------
        // MEAL LOGIC CONFIGURATION
        // --------------------------------------------------------------------------------

        // Helper to check if a category/name fits "Lunch" (Heavier/Carby) vs "Dinner" (Lighter/Protein)
        function isLunch(item) {
            const txt = (item.name + " " + item.category).toLowerCase();
            // Lunch: Rice, Pasta, Legumes, Stews, Potatoes, Red Meat dishes
            if (/arroz|pasta|cereal|legumbre|lenteja|frijol|guiso|estofado|lasaÃ±a|spaghetti|macarron|paella|cocido/.test(txt)) return true;
            if (/texmex|burrito|taco/.test(txt)) return true; // Heavy
            return false;
        }

        function isDinner(item) {
            const txt = (item.name + " " + item.category).toLowerCase();
            // Dinner: Fish, Eggs, Chicken (grilled/light), Soup, Salad, Vegetables
            if (/pescado|atÃºn|marisco|huevo|tortilla|sopa|crema|ensalada|vegetal|verdura|brÃ³coli|espinaca/.test(txt)) return true;
            if (/pollo|pavo/.test(txt) && !/asado|frito/.test(txt)) return true; // Light chicken OK
            return false;
        }

        const EXTRA_RECIPES = [
            { name: "Burritos de Carne", base: "Carne", category: "TexMex", type: "special", suitable: "lunch" },
            { name: "Spaghetti BoloÃ±esa", base: "Pasta", category: "Italiana", type: "special", suitable: "lunch" },
            { name: "AlbÃ³ndigas en Salsa", base: "Carne", category: "Casera", type: "special", suitable: "lunch" },
            { name: "Tacos de Carne", base: "Carne", category: "TexMex", type: "special", suitable: "lunch" },
            { name: "Arroz Tres Delicias", base: "Arroz", category: "AsiÃ¡tica", type: "special", suitable: "lunch" },
            { name: "Curry de Pollo", base: "Pollo", category: "AsiÃ¡tica", type: "special", suitable: "lunch" },
            { name: "Estofado de Ternera", base: "Carne", category: "Guiso", type: "special", suitable: "lunch" },
            { name: "LasaÃ±a de Carne", base: "Pasta", category: "Italiana", type: "special", suitable: "lunch" },

            { name: "Pescado al Horno con Patatas", base: "Pescado", category: "Horno", type: "special", suitable: "dinner" },
            { name: "Pollo Asado con Patatas", base: "Pollo", category: "Horno", type: "special", suitable: "lunch" }, // Roast chicken is lunch usually in Spain
            { name: "Sopa de Pollo", base: "Sopa", category: "Sopa", type: "special", suitable: "dinner" },
            { name: "Crema de CalabacÃ­n", base: "Vegetal", category: "Cuchara", type: "special", suitable: "dinner" }
        ];

        // Seeded RNG
        let currentSeed = 1;
        function seed(s) { currentSeed = s; }
        function random() {
            var x = Math.sin(currentSeed++) * 10000;
            return x - Math.floor(x);
        }

        function generateSchedule(stats, year, month) {
            // Seed based on YearMonth to keep it consistent per page but infinite
            seed(year * 100 + month);

            // Prepare Pools
            // LUNCH Pool (Heavy)
            const lunchPool = stats.filter(f => isLunch(f) && f.min_rating >= 2);
            // DINNER Pool (Light)
            const dinnerPool = stats.filter(f => isDinner(f) && f.min_rating >= 2);

            // Ingredients for constructing meals if not special
            const proteins = stats.filter(f => /proteÃ­na|carne|pollo|pescado|huevo|tofu|atÃºn|cerdo|camarones|pavo/i.test(f.category + f.name));
            const veggies = stats.filter(f => /vegetal|verdura|brÃ³coli|espinaca|zanahoria|tomate|pepino|champiÃ±on|ensalada/i.test(f.category + f.name));
            const carbs = stats.filter(f => /cereal|arroz|pasta|pan|papa|patata|tubÃ©rculo/i.test(f.category + f.name));

            // Specials
            let specials = [];
            // Add Extras if preferred
            EXTRA_RECIPES.forEach(r => {
                // Check if family generally likes the base
                const match = stats.find(s => s.name.includes(r.base) && s.avg_rating >= 3);
                if (match || r.base === "Vegetal" || r.base === "Sopa") {
                    specials.push(r);
                }
            });

            // Sorting for consistency
            [lunchPool, dinnerPool, proteins, veggies, carbs, specials].forEach(arr => arr.sort((a, b) => a.name.localeCompare(b.name)));

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const schedule = [];

            // Tracking to avoid repetition
            let lastDayProteins = []; // [LunchProtein, DinnerProtein]
            let lastDayCarbs = [];    // [LunchCarb, DinnerCarb]

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dayOfWeek = date.getDay(); // 0:Sun, 1:Mon
                const dayPlan = { day: day, meals: [] };

                // Trackers for TODAY to pass to tomorrow
                let todayProteins = [];
                let todayCarbs = [];

                // Rules
                // Fri(5)/Sat(6) -> Glovo
                if (dayOfWeek === 5 || dayOfWeek === 6) {
                    dayPlan.isGlovo = true;
                    // Reset trackers effectively (Glovo is wildcard) or keep yesterday's to prevent Mon repeat? 
                    // Let's just clear for Glovo days so Sunday isn't blocked by Thursday
                    todayProteins = [];
                    todayCarbs = [];
                }
                else if (dayOfWeek === 0) { // Sunday: Lunch & Dinner
                    // Lunch
                    const lunch = selectMeal('lunch', specials, lunchPool, proteins, carbs, veggies, lastDayProteins, lastDayCarbs, todayProteins, todayCarbs);
                    dayPlan.meals.push(lunch);
                    updateTrackers(lunch, todayProteins, todayCarbs);

                    // Dinner
                    const dinner = selectMeal('dinner', specials, dinnerPool, proteins, carbs, veggies, lastDayProteins, lastDayCarbs, todayProteins, todayCarbs);
                    dayPlan.meals.push(dinner);
                    updateTrackers(dinner, todayProteins, todayCarbs);
                }
                else { // Mon-Thu: Dinner Only
                    const dinner = selectMeal('dinner', specials, dinnerPool, proteins, carbs, veggies, lastDayProteins, lastDayCarbs, todayProteins, todayCarbs);
                    dayPlan.meals.push(dinner);
                    updateTrackers(dinner, todayProteins, todayCarbs);
                }

                schedule.push(dayPlan);

                // Pass today's to next iteration
                lastDayProteins = todayProteins;
                lastDayCarbs = todayCarbs;
            }
            return schedule;
        }

        function updateTrackers(meal, protList, carbList) {
            if (!meal) return;
            // Extract key ingredient names for tracking
            const p = getIngredientCategory(meal.main.name);
            protList.push(p);

            if (meal.carb) carbList.push(getIngredientCategory(meal.carb.name));
            // Also check main category (e.g. Pasta dish)
            if (/pasta|arroz/.test((meal.main.name + meal.main.category).toLowerCase())) {
                carbList.push(getIngredientCategory(meal.main.name));
            }
        }

        function getIngredientCategory(name) {
            name = name.toLowerCase();
            if (/pollo|pavo/.test(name)) return "pollo";
            if (/res|ternera|carne|buey/.test(name)) return "carne_roja";
            if (/cerdo/.test(name)) return "cerdo";
            if (/pescado|atÃºn|merluza|salmÃ³n/.test(name)) return "pescado";
            if (/huevo|tortilla/.test(name)) return "huevo";
            if (/arroz/.test(name)) return "arroz";
            if (/pasta|spaghetti|macarron|lasaÃ±a/.test(name)) return "pasta";
            if (/lenteja|frijol/.test(name)) return "legumbre";
            return name;
        }

        function selectMeal(type, specials, typePool, prots, carbs, vegs, avoidP, avoidC, currentP, currentC) {
            // Filter Specials by Type (Lunch/Dinner)
            let suitableSpecials = specials.filter(s => s.suitable === type || (!s.suitable && type === 'lunch'));

            // Filter Regular items if constructing
            let pPool = (type === 'lunch') ? prots : prots.filter(p => !/carne|res|cerdo/.test(p.name.toLowerCase())); // Prefer light protein for dinner
            if (pPool.length === 0) pPool = prots; // Fallback

            // 40% chance special
            if (random() < 0.4 && suitableSpecials.length > 0) {
                // Try to find one not maintained in avoid lists
                let cand = pickValid(suitableSpecials, avoidP, avoidC, currentP, currentC);
                if (cand) return { type: 'special', main: cand, note: getNote(cand) };
            }

            // Construct Standard Meal
            // 1. Protein
            let main = pickValid(pPool, avoidP, avoidC, currentP, currentC);
            if (!main) main = pPool[Math.floor(random() * pPool.length)];

            // 2. Veggie
            let veg = vegs[Math.floor(random() * vegs.length)];

            // 3. Carb (Only if Lunch, or very light for Dinner?)
            // User said "Cena y comida son diferentes". Usually Dinner has no heavy carb or very little.
            // Let's say Lunch always has Carb. Dinner has Carb only if soup/light potato.
            // Actually, keep it simple: Lunch = Protein+Carb+Veg. Dinner = Protein+Veg (Low Carb).

            let carb = null;
            if (type === 'lunch') {
                const cPool = carbs;
                carb = pickValid(cPool, avoidP, avoidC, currentP, currentC);
                if (!carb && cPool.length > 0) carb = cPool[Math.floor(random() * cPool.length)];
            } else {
                // Dinner: Maybe just small potato or none?
                // "No repetir carb en el dia siguiente" implies carbs exist.
                // Let's add a small side carb occasionally or ensure Veggie is substantial.
                // Or use a very light carb (pan check?)
                // For simplicity, let's skip carb for Dinner to respect "different".
                // BUT user wants to check repetition logic.
                // We will assign a Veggie. And maybe a light carb if needed.
                // We'll skip specific carb slot for dinner to distinguish it clearly as requested.
            }

            // Formatting
            if (carb) {
                return { type: 'standard', main: main, carb: carb, veg: veg, note: getNote(main) };
            } else {
                return { type: 'standard', main: main, veg: veg, note: getNote(main) };
            }
        }

        // Pick item that doesn't conflict with avoid lists
        function pickValid(list, avoidP, avoidC, currP, currC) {
            // Shuffle
            let shuffled = list.slice().sort(() => random() - 0.5);

            for (let item of shuffled) {
                let cat = getIngredientCategory(item.name);

                // Check Previous Day Conflict
                if (avoidP.includes(cat)) continue;
                if (avoidC.includes(cat)) continue;

                // Check Today Conflict (e.g. Lunch had chicken, Dinner shouldn't)
                if (currP.includes(cat)) continue;
                if (currC.includes(cat)) continue;

                return item;
            }
            // If strict fail, pick first (loose fallback)
            return shuffled[0];
        }

        // Utils
        function getNote(item) {
            if (!item) return null;
            const txt = (item.name + " " + item.category).toLowerCase();
            if (/texmex|casera|italiana|espaÃ±ola|asiÃ¡tica|americana/.test(txt)) return { text: item.category, class: 'tag-purple' };
            if (/pescado|atÃºn|mar/.test(txt)) return { text: 'Omega-3', class: 'tag-blue' };
            if (/huevo|frijol|legumbre|lenteja/.test(txt)) return { text: 'Ligero', class: 'tag-green' };
            if (/pollo|pavo/.test(txt)) return { text: 'Magra', class: 'tag-orange' };
            if (/res|cerdo|estofado|ternera/.test(txt)) return { text: 'Hierro', class: 'tag-red' };
            if (/sopa|crema/.test(txt)) return { text: 'Comfort', class: 'tag-purple' };
            return null;
        }

        function renderCalendar(schedule) {
            const calDiv = document.getElementById('calendar');
            // Clear current days (keep headers)
            const headers = Array.from(calDiv.children).slice(0, 7);
            calDiv.innerHTML = '';
            headers.forEach(h => calDiv.appendChild(h));

            // Empty Cells
            const firstDate = new Date(currentYear, currentMonth, 1);
            let firstDay = firstDate.getDay();
            let emptyCells = firstDay === 0 ? 6 : firstDay - 1;

            for (let i = 0; i < emptyCells; i++) {
                const div = document.createElement('div');
                div.className = 'day-card';
                div.style.background = 'transparent';
                div.style.boxShadow = 'none';
                div.style.border = 'none';
                calDiv.appendChild(div);
            }

            schedule.forEach(day => {
                const div = document.createElement('div');
                div.className = 'day-card';

                const num = document.createElement('div');
                num.className = 'day-number';
                num.textContent = day.day;
                div.appendChild(num);

                if (day.isGlovo) {
                    div.classList.add('glovo-card');
                    div.innerHTML += `
                        <div style="font-size: 2.5rem; margin-top:20px;">ðŸ›µ</div>
                        <div style="font-weight: 800; color: #b45309; margin-top:5px;">GLOVO</div>
                    `;
                } else {
                    if (day.meals.length >= 2) {
                        div.classList.add('sunday-card');
                        div.innerHTML += `<div class="meal-type">Comida (Lunch)</div>`;
                        div.innerHTML += renderMealContent(day.meals[0]);
                        div.innerHTML += `<div class="meal-type">Cena (Dinner)</div>`;
                        div.innerHTML += renderMealContent(day.meals[1]);
                    } else if (day.meals.length === 1) {
                        div.innerHTML += `<div class="meal-type">Cena (Dinner)</div>`;
                        div.innerHTML += renderMealContent(day.meals[0]);
                    }
                }
                calDiv.appendChild(div);
            });
        }

        function renderMealContent(meal) {
            if (!meal) return '';
            let html = '';
            if (meal.type === 'special') {
                html += `<div class="meal-content">ðŸ¥£ <b>${meal.main.name}</b></div>`;
            } else {
                html += `<div class="meal-content">
                    <b>${meal.main.name}</b>`;
                if (meal.carb) html += `<span style="color:var(--text-muted);">+ ${meal.carb.name}</span>`;
                html += `<span style="color:var(--text-muted);">+ ${meal.veg.name}</span>
                </div>`;
            }
            if (meal.note) {
                html += `<span class="tag ${meal.note.class}">${meal.note.text}</span>`;
            }
            return html;
        }

        // Portions & Shopping List (Simplified usage of previous logic)
        const PORTIONS = {
            MEAT: 0.200, FISH: 0.200, RICE: 0.080, PASTA: 0.100, POTATO: 0.250,
            VEG: 0.200, EGG: 2, SOUP: 0.3
        };
        const FAMILY_SIZE = 4;

        function generateShoppingList(schedule) {
            const listContainer = document.getElementById('shopping-lists');
            listContainer.innerHTML = '';

            // Generate list for the currently displayed month
            // We can group by Week 1, 2, 3, 4 of the month view

            const weeks = {};
            schedule.forEach(day => {
                // Determine week index relative to start of month grid
                // Approx: (day + offset) / 7
                let d = new Date(currentYear, currentMonth, day.day);
                let w = getWeekNumber(d);
                if (!weeks[w]) weeks[w] = { id: w, products: {} };

                day.meals.forEach(m => {
                    if (!m) return;
                    // Add Main
                    addProduct(weeks[w].products, m.main);
                    // Add Sides
                    if (m.carb) addProduct(weeks[w].products, m.carb);
                    if (m.veg) addProduct(weeks[w].products, m.veg);
                });
            });

            Object.keys(weeks).map(Number).sort((a, b) => a - b).forEach((wk, i) => {
                const div = document.createElement('div');
                div.className = 'week-list';
                div.innerHTML = `<h3>Semana ${i + 1}</h3>`;
                const ul = document.createElement('ul');
                ul.className = 'shopping-items';

                const products = weeks[wk].products;
                Object.keys(products).sort().forEach(pName => {
                    const item = products[pName];
                    const qty = calculateQty(pName, item);
                    ul.innerHTML += `<li><span>${pName}</span><span>${qty}</span></li>`;
                });

                div.appendChild(ul);
                listContainer.appendChild(div);
            });
        }

        function addProduct(dict, item) {
            if (!item) return;
            if (!dict[item.name]) dict[item.name] = { count: 0, cat: item.category };
            dict[item.name].count++;
        }

        function calculateQty(name, data) {
            const low = (name + " " + data.cat).toLowerCase();
            let p = 1.0; let unit = "pack";

            if (/pollo|pavo|carne|res|cerdo|ternera/.test(low)) { p = PORTIONS.MEAT; unit = "kg"; }
            else if (/pescado|atÃºn|salmÃ³n/.test(low)) { p = PORTIONS.FISH; unit = "kg"; }
            else if (/arroz|cereal/.test(low)) { p = PORTIONS.RICE; unit = "kg"; }
            else if (/pasta|spaghetti|macarron/.test(low)) { p = PORTIONS.PASTA; unit = "kg"; }
            else if (/patata|papa/.test(low)) { p = PORTIONS.POTATO; unit = "kg"; }
            else if (/huevo/.test(low)) { p = PORTIONS.EGG; unit = "u."; }
            else if (/sopa|crema/.test(low)) { p = PORTIONS.SOUP; unit = "L"; }
            else if (/vegetal|verdura|ensalada|tomate/.test(low)) { p = PORTIONS.VEG; unit = "kg"; }

            let val = data.count * p * FAMILY_SIZE;
            if (unit === "u.") return `${Math.ceil(val)} u.`;
            if (unit === "pack") return `${data.count} u.`;
            return `${val.toFixed(2)} ${unit}`;
        }

        function getWeekNumber(d) {
            const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            const dayNum = date.getUTCDay() || 7;
            date.setUTCDate(date.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
            return Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
        }

        window.onload = init;
    </script>
</body>

</html>